<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pending Document Approvals</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Parse and normalize email from URL
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email')?.trim().toLowerCase();

    const contentDiv = document.getElementById("content");

    if (!email) {
      contentDiv.innerHTML = `<div class="alert alert-danger">Missing email parameter.</div>`;
      throw new Error("Missing email parameter.");
    }

    console.log("üîç Email from URL:", email);

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyALkCr_VhPMgF8lUGkZdquF7fRHRQMR-bg",
      authDomain: "oraclesp-7295a.firebaseapp.com",
      projectId: "oraclesp-7295a",
      storageBucket: "oraclesp-7295a.firebasestorage.app",
      messagingSenderId: "412945353914",
      appId: "1:412945353914:web:16df873fba99d63d3c0683",
      measurementId: "G-1536B515RY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadApprovals() {
      console.log("üì° Running Firestore query...");

      try {
        const q = query(
          collection(db, "doclist"),
          where("ApproverEmail", "==", email),
          where("ApprovalStatus", "==", "Pending for approval")
        );

        const querySnapshot = await getDocs(q);

        console.log("‚úÖ Query completed. Documents found:", querySnapshot.size);

        if (querySnapshot.empty) {
          contentDiv.innerHTML = `<div class="alert alert-info">No pending documents for <strong>${email}</strong>.</div>`;
          return;
        }

        let listHTML = '<ul class="list-group">';
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          console.log("üìÑ Document:", doc.id, data);

          const fileName = doc.id;
          listHTML += `<li class="list-group-item">${fileName}</li>`;
        });
        listHTML += '</ul>';

        contentDiv.innerHTML = listHTML;
      } catch (err) {
        console.error("‚ùå Firestore query error:", err);
        contentDiv.innerHTML = `<div class="alert alert-danger">Error loading data. Please try again later.</div>`;
      }
    }

    window.addEventListener("DOMContentLoaded", loadApprovals);
  </script>
</head>
<body>
  <div class="container my-5">
    <h3 class="mb-4">Pending Document Approvals</h3>
    <div id="content">
      <div class="text-muted">Loading pending approvals...</div>
    </div>
  </div>
</body>
</html>
